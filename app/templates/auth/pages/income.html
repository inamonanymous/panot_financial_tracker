{% extends 'auth/layout.html' %}
{% block body %}
    <!-- Sidebar -->
    {% include 'auth/partials/sidebar.html' %}
    <!-- End of Sidebar -->

    <!-- Main Content -->
    <div id="content">


        <!-- Topbar -->
        {% include 'auth/partials/topbar.html' %}
        <!-- End of Topbar -->

        <!-- Begin Page Content -->
        <div class="container-fluid">
            <!-- Modal -->
            {% include 'auth/modals/add_income.html' %}
            {% include 'auth/modals/add_category.html' %}
            {% include 'auth/modals/edit_category.html' %}
            
            <!-- Page Heading -->
            <h1 class="h3 mb-2 text-gray-800">My Income</h1>
            <p class="mb-4">
                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
            </p>

            <!-- Button trigger modal -->
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addIncomeModal">
            Add Income
            </button>
            {% if error_message %}
                <label for="validationError" class="form-label text-danger">
                    {{ error_message }}
                </label>
            {% endif %}
            
            <!-- DataTales Example -->
             <div class="row">
                <div class="col-xl-8 col-lg-7">
                    {% include 'auth/tables/income_table.html' %}
                </div>
                <div class="col-xl-4 col-lg-5">
                    {% include 'auth/cards/categories_card.html' %}
                </div>
             </div>
        </div>
        <!-- /.container-fluid -->

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const editButtons = document.querySelectorAll(".js-edit-category-btn");
                const form = document.getElementById("editCategoryForm");
                const nameInput = document.getElementById("editCategoryName");
                const submitButton = document.getElementById("editCategorySubmit");

                if (!form || !nameInput || !submitButton) {
                    return;
                }

                const setLoadingState = function (isLoading) {
                    nameInput.disabled = isLoading;
                    submitButton.disabled = isLoading;
                };

                editButtons.forEach(function (button) {
                    button.addEventListener("click", function (event) {
                        event.preventDefault();

                        const apiUrl = button.dataset.categoryApiUrl;
                        const updateUrl = button.dataset.categoryUpdateUrl;

                        if (!apiUrl || !updateUrl) {
                            return;
                        }

                        form.action = updateUrl;
                        nameInput.value = "";
                        setLoadingState(true);

                        fetch(apiUrl, {
                            method: "GET",
                            headers: {
                                "Accept": "application/json"
                            }
                        })
                            .then(function (response) {
                                if (!response.ok) {
                                    throw new Error("Failed to fetch category");
                                }
                                return response.json();
                            })
                            .then(function (data) {
                                nameInput.value = data.name || "";
                            })
                            .catch(function () {
                                nameInput.value = "";
                                alert("Unable to load category details. Please try again.");
                            })
                            .finally(function () {
                                setLoadingState(false);
                            });
                    });
                });
            });
        </script>

        </div>
        <!-- End of Main Content -->
{% endblock %}

